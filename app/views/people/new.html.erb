<% content_for :navbar do %>
  <%= render "pages/admin_navbar" %>
<% end %>
<%= link_to people_path, class: "back_link" do %>
  <i class="material-icons">arrow_back_ios</i>
  <span>Annuler et revenir à l'index</span>
<% end %>
<h1>Créer une nouvelle fiche personne</h1>
<%= simple_form_for(@person) do |f| %>
  <div class="form-half">
    <div class="left">
      <%= f.input :gender, 
                  label: false, 
                  as: :radio_buttons, 
                  collection: [['0', 'Femme'], ['1', 'Homme']], 
                  label_method: :second, 
                  value_method: :first,
                  required: true %>
    </div>
    <div class="right">
      <%= f.input :profile_pic, 
                  label: "Photo de profil", 
                  as: :file %>
    </div>
  </div>
  <div class="form-half">
    <div class="left">
      <%= f.input :first_name, 
                  label: "Prénom", 
                  as: :string,
                  input_html: { autocomplete: 'off' },
                  placeholder: "ex : Ivan" %>
    </div>
    <div class="right">
      <%= f.input :last_name, 
                  label: "Nom de famille", 
                  as: :string,
                  placeholder: "ex : GORKI",
                  input_html: { autocomplete: 'off' },
                  required: true %>
    </div>
  </div>
  <div class="form-half">
    <div class="left">
      <%= f.input :middle_name, 
                  label: "Autres prénoms",
                  input_html: { autocomplete: 'off' },
                  as: :string %>
    </div>
    <div class="right">
      <%= f.input :spouse_name, 
                  label: "Nom d'épouse", 
                  input_html: { autocomplete: 'off' },
                  as: :string %>
    </div>
  </div>
  <hr>
  <div class="form-half">
    <div class="left">
      <%= f.input :birth_date, 
                  input_html: { autocomplete: 'off' },
                  label: "Date de naissance", 
                  as: :date_picker %>
    </div>
    <div class="right">
      <%= f.input :birth_place, 
                  label: "Lieu de naissance", 
                  as: :string %>
    </div>
  </div>
  <div class="form-half">
    <div class="left">
      <%= f.input :death_date,
                  input_html: { autocomplete: 'off' },
                  label: "Date de décès", 
                  as: :date_picker %>
    </div>
    <div class="right">
      <%= f.input :death_place, 
                  label: "Lieu de décès", 
                  as: :string %>
    </div>
  </div>
  <hr>
  <%= f.input :biography, 
              label: "Biographie", 
              as: :text,
              placeholder: "Renseigner ici la biographie de cette personne. Par exemple les différents évènements qui ont marqué sa vie, ses engagements etc." %>
  <hr>
  <div class="family-link hidden">
    <%= f.simple_fields_for :family_links do |link| %>
      <div class="form-half">
        <div class="left">
          <%= link.input  :person_b_id,
                          label: "Proche",
                          collection: Person.order(:last_name), 
                          prompt: "Personne en relation",
                          label_method: :full_name_index, 
                          input_html: { name: 'person[family_links_attributes][0][person_b_id]' },
                          value_method: :id %>
        </div>
        <div class="right">
          <%= link.input  :link_b_to_a,
                          label: "Ce proche est son/sa",
                          collection: ["Épouse", "Époux", "Mère", "Père", "Sœur", "Frère", "Fille", "Fils", "Cousine", "Cousin", "Tante", "Oncle", "Nièce", "Neveu", "Grand-mère", "Grand-père", "Petite-fille", "Petit-fils"],
                          input_html: { name: 'person[family_links_attributes][0][link_b_to_a]' },
                          prompt: "Lien de parenté" %>
        </div>
      </div>
    <% end %>
  </div>
  <button class="btn btn-red remove-family-link block hidden">Enlever le dernier lien</button>
  <button class="btn add-family-link block">Ajouter un lien de parenté</button>
  <%= f.input :notes, 
              label: "Carnet de notes", 
              as: :text,
              placeholder: "Renseigner ici les commentaires historiographiques qui concernent cette personne. Par exemple comment ses informations ont été obtenues, quelle institution détient certains documents." %>
  <%= f.button :submit, "Créer la fiche", type: "submit", class: "btn" %>
<% end %>

<script>
  // DatePicker
  $("input.date_picker").datepicker({ dateFormat: 'yy-mm-dd', changeYear: true, yearRange: '1800:2030' });

  // Add Family Link
  var i = 1;
  $('.add-family-link').click(function(event){
    event.preventDefault();
    var lastParent = $('.family-link').last();

    if (lastParent.hasClass('hidden')) {
      lastParent.removeClass('hidden');
    } else {
      var newParent = lastParent.clone();
      newParent.find('select').first().attr('name', 'person[family_links_attributes]['+i+'][person_b_id]');
      newParent.find('select').first().attr('id', 'person_family_links_attributes_'+i+'_person_b_id');
      newParent.find('select').last().attr('name', 'person[family_links_attributes]['+i+'][link_b_to_a]');
      newParent.find('select').last().attr('id', 'person_family_links_attributes_'+i+'_link_b_to_a');
      lastParent.after(newParent);
      i++;
    }
  });

  var attributes = ["person_b_id", "link_b_to_a"];
  var i = $('.family-link').length;

  $('.add-family-link').click(function(event){
    event.preventDefault();
    $('.remove-family-link').removeClass('hidden');
    var lastSieve = $('.sieve-tuple').last();
    var newSieve = lastSieve.clone();
    newSieve.find('input').each(function(j) {
      $(this).val('');
      $(this).attr('name', 'granulometry_report[sieves_attributes]['+i+']['+ attributes[j] +']');
      $(this).removeAttr('id');
    });
    lastSieve.after(newSieve);
    i++;
  });
  $('.remove-sieve').click(function(event){
    event.preventDefault();

    var removeButton = $('.remove-sieve').last;
    var sieves = $('.sieve-tuple').length;
    var lastSieve = $('.sieve-tuple').last();

    if (sieves == 2) {
      $('.remove-sieve').addClass('hidden');
    }
    lastSieve.remove();
  });
</script>